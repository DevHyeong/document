## 스타터와 Jetty 서버 구성 추가

### /META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports
- 빈으로 정의된 팩토리 메서드가 특정 조건에 맞으면 자동으로 등록됨

### ./gradlew dependencies --configuration compileClasspath
- 의존성 트리가 표출

### spring-boot-starter-jetty 의존성 추가
- 톰캣이 아닌 제티로 서블릿 컨테이너 구성
- 조건에 따라 톰캣 또는 제티가 서블릿 컨테이너로 올라감
- 제티 팩토리 메서드 정의
  ```java
  @MyAutoConfiguration
  @Conditional(JettyWebServerConfig.JettyCondition.class)
  public class JettyWebServerConfig {
    @Bean("jettyWebServerFactory")
    public ServletWebServerFactory servletWebServerFactory(){
      return new JettyServletWebServerFactory();
    }

    static class JettyCondition implements Condition {
      @Override
      public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata){
        return true;
      }
    }
  }
  ```
### @Conditional
- 클래스 또는 메소드 레벨에서 정의 가능
- 인터페이스 Condition 타입에 의존
  
  ![image](https://github.com/DevHyeong/document/assets/44819285/818f57cf-430e-42a5-9c7c-8d9577ceaaa6)

## @Conditional 학습 테스트
- ApplicationContextRunner 사용
```java
  ApplicationContextRunner contextRunner = new ApplicationContextRunner();
  contextRunner.withUserConfiguration(Config1.class)
        .run(context -> {
          assertThat(context).hasSingleBean(MyBean.class);
          assertThat(context).hasSingleBean(Config1.class);
        });

  ApplicationContextRunner contextRunner = new ApplicationContextRunner();
  contextRunner.withUserConfiguration(Config2.class)
        .run(context -> {
          assertThat(context).doesNotHaveBean(MyBean.class);
          assertThat(context).doesNotHaveBean(Config1.class);
        });

  AnnotationConfigApplicationContext ac = new AnnotationConfigApplicationContext();
  ac.register(Config1.class);
  ac.refresh();
```
### @Conditional 커스텀
- 엘리먼트 또는 속성값에 따라 Configuration 또는 Bean을 등록할 것인지 판단하는 어노테이션 만들기
```java
  @Retention(RententionPolicy.RUNTIME)
  @Target(ElementType.TYPE)
  @Conditional(BooleanCondition.class)
  @interface BooleanConditional{
    boolean value();
  }

  public class BooleanCondition implements Condition {
      @Override
      public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata){
        Map<String, Object> annotationAttributes = metadata.getAnnotationAttributes(BooleanConditional.class.getName());
        Boolean value = (Boolean) annotationAttributes.get("value");
        return value;
      }
  }

  @Configuration
  @BooleanConditional(true)
  statis class Config1{
    ...생략
  }
```

### 커스톰 @Conditional
- 어떤 클래스의 존재함을 기준으로 @Conditional 활용(보편적인 방법)
  ```java
    class TomcatCondition implements Condition {
      @Override
      public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata){
        return ClassUtils.isPresent("org.apache.catalina.startup.Tomcat", context.getClassLoader()); 
      }
    }
  ```
- @ConditionalMyOnClass 정의
- TomcatCondition 클래스를 추상화하는 작업
  ```java
  @Retention(RetentionPolicy.RUNTIME)
  @Target({ElementType.TYPE, ElementType.METHOD})
  @Conditional(MyOnClassCondition.class)
  public @interface ConditionalMyOnClass{
    String value();
  }

  public class MyOnClassCondition implements Condition {
      @Override
      public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata){
        Map<String, Object> attrs = metadata.getAnnotationAttributes(ConditionalMyOnClass.class.getName());
        String value = (String) attrs.get("value");
        return ClassUtils.isPresent(value context.getClassLoader()); 
      }
  }
  ```

 






