# 7징 스프링 핵심 기술의 응용

## 7.1 SQL과 DAO의 분리
- SQL 제공 기능을 분리해서 다양한 SQL 정보 소스를 사용할 수 있고 운영 중에 동적으로 갱신도 가능한 유연하고 확장성이 뛰어난 SQL 서비스를 만들어보자.
- SQL 서비스 인터페이스를 정의하여 Dao가 SQL 서비스 인터페이스 타입의 구현 클래스로 정의된 빈을 DI 받도록 설정 변경

```xml
<bean id="useDao" class="springbook.dao.UserDaoJdbc">
  <property name="dataSource" ref="dataSource" />
  <property name="sqlService" ref="sqlService" />
</bean>

<bean id="sqlService" class="springbook.user.sqlservice.SimpleSqlService">
  <property name="sqlMap">
    <map>
      <entry key="userAdd" value="sql문" />
      ...
    </map>
  </property>
</bean>
```

- 이와 같이 변경함으로써 얻은 장점
    1. 이제 UserDao를 포함한 모든 DAO는 SQL을 어디에 저쟁해두고 가져오는지에 대해서는 전혀 신경 쓰지 않아도 된다.
    2. 구체적인 구현 방법과 기술에 상관없이 SqlService 인터페이스 타입의 빈을 DI 받아서 필요한 SQL을 가져다 쓰기만 하면 된다.
    3. sqlService 빈에는 DAO에는 전혀 영향을 주지 않은 채로 다양한 방법으로 구현된 SqlService 타입 클래스를 적용할 수 있다.

## 인터페이스의 분리오 자기참조 빈
- 스프링의 XML 설정파일에서 <bean> 태그 안에 SQL 정보를 넣어놓고 활용하는 건 좋은 방법이 아니다. 그보다는 SQL을 저장해두는 전용 포맷을 가진 독립적인 파일을 이용하는 편이 바람직하다.

### JAXB
- XML 문서정보를 거의 동일한 구조의 오브젝트로 직접 매핑해주는 장점이 있다.
- JAXB는 XML 문서의 구조를 정의한 스키마를 이용해서 매핑할 오브젝트의 클래스까지 자동으로 만들어주는 컴파일러도 제공해준다.

### 언마샬링
- 언마샬링: XML 문서를 읽어서 자바의 오브젝트로 변환하는 작업을 말한다.
- 마샬링: 반대로 바인딩 오브젝트를 XML 문서로 변환하는 작업을 말한다. 자바오브젝트를 바이트 스트림으로 바꾸는 걸 직렬화라고 부르는 것과 비슷하다.

### XML SQL 서비스
- 언제 JAXB를 사용해 XML 문서를 가져올지 생각해봐야 한다. DAO가 SQL을 요청할 때마다 매번 XML 파일을 다시 읽어서 SQL를 찾는 건 너무 비효율적인 방법이다. 특별한 이유가 없는 한 XML 파일은 한 번만 읽도록 해야 한다. XML 파일로부터 읽은 내용은 어딘가에 저장해두고 DAO에서 요청이 올 때 사용해야 한다.
- 처음 SQL을 읽어들이는 건 어디서 해야 할까? 항상 그래 왔듯이 일단 가장 간단한 방법으로 기능이 동작하게 만든 다음, 차근차근 좀 더 나은 구조와 코드로 개선해나가면 된다.
```java
public class XmlSqlService implements SqlService {
  private Map<String, String> sqlMap = new HashMap<String, String>();

  public XmlSqlService(){
    String contextPath = Sqlmap.class.getPackage().getName();
    try{
      JAXBContext context = JAXBContext.newInstance(contextPath);
      Unmarshaller unmarshaller = context.createUnmarshaller();
      InputStream is = UserDao.class.getResourceAsStream("sqlmap.xml");
      Sqlmap sqlmap = (Sqlmap) unmarshaller.unmarshal(is);

      for(SqlType sql: sqlmap.getSql()){
        sqlMap.put(sql.getKey(), sql.getValue());
      }
    }catch(JAXBException e){
      throw new RuntimeException(e);
    }
  }
  ... 생략
  public String getSql(String key) 

}
```

### 빈의 초기화 작업
- XmlSqlService 코드는 아래와 같은 개선점이 필요해보인다.
- 생성자에서 예외가 발생할 수도 있는 복잡한 초기화 작업을 다루는 것은 좋지 않다. 오브젝트를 생성하는 중에 생성자에서 발생하는 예외는 다루기 힘들고, 상속하기 불편하며 보안에도 문제가 생길 수 있다. 일단 초기 상태를 가진 오브젝트를 만들어놓고 별도의 초기화 메소드를 사용하는 방법이 바람직하다.
- 읽어들일 파일의 위치와 이름이 코드에 고정되어 있다.
